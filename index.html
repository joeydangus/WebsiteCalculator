
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Instant Quote Calculator</title>
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  /* Brand font: Aeonik Medium (update URL to your hosted file) */
  @font-face {
    font-family: "Aeonik";
    src: url("/fonts/Aeonik-Medium.woff2") format("woff2"); /* <-- update path */
    font-weight: 500;
    font-style: normal;
    font-display: swap;
  }

  /* Minimalist palette aligned to the exact HydroBlok green */
  :root{
    --page-bg:#ffffff;
    --card-bg:#ffffff;
    --text:#0f172a;
    --muted:#64748b;

    /* Exact HydroBlok logo green + darker hover */
    --primary:#509E2E;      /* dominant green from your logo */
    --primary-700:#407E25;  /* ~20% darker for hover/pressed */

    --border:#e5e7eb;
    --soft-shadow:0 10px 30px rgba(15,23,42,.10);
    --radius:20px;
  }

  *{box-sizing:border-box}
  body{
    margin:0; background: var(--page-bg);
    font-family:"Aeonik", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    color: var(--text);
  }

  /* Single rounded box */
  .shell{max-width:980px;margin:40px auto;padding:0 16px}
  .box{
    background:var(--card-bg); border:1px solid var(--border);
    border-radius:var(--radius); box-shadow:var(--soft-shadow); overflow:hidden;
  }

  .hero{padding:20px 22px; border-bottom:1px solid var(--border)}
  .hero h1{margin:0 0 4px; font-size:clamp(1.25rem,2.5vw,1.6rem); font-weight:700}
  .hero p{margin:0; color:var(--muted); font-size:.95rem}

  .grid{display:grid; grid-template-columns:1.05fr .95fr; gap:0}
  @media (max-width:880px){ .grid{grid-template-columns:1fr} }

  .pane{padding:18px 22px}
  .pane + .pane{border-left:1px solid var(--border)}
  @media (max-width:880px){
    .pane + .pane{border-left:none; border-top:1px solid var(--border)}
  }

  .pane header{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px}
  .pane h2{margin:0; font-size:1.05rem; font-weight:700}
  .muted{color:var(--muted)}

  /* Controls */
  .control{margin-bottom:14px}
  .label{font-weight:600; margin-bottom:6px}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  input[type="number"], input[type="text"]{
    flex:1 1 240px; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; font-size:1rem;
    -moz-appearance:textfield; appearance:textfield; /* remove steppers */
  }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
  input:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(80,158,46,.18)}

  /* faint placeholder for itemized Mat/Lab inputs */
  .item-mat::placeholder, .item-lab::placeholder { color: rgba(15,23,42,0.35); }

  .seg{display:flex; background:#f8fafc; border:1px solid var(--border); border-radius:999px; padding:4px}
  .seg button{
    flex:1; border:0; background:transparent; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600; color:var(--text);
  }
  .seg button.active{background:#fff; border:1px solid var(--border); color:var(--primary)}

  .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
  .btn{
    appearance:none; border:1px solid var(--border); background:#fff; color:var(--text);
    padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
  }
  .btn.primary{background:var(--primary); border-color:var(--primary-700); color:#fff}
  .btn.primary:hover{background:var(--primary-700)}

  /* Key Points — two columns, subtle */
  .kvp{margin-top:10px; border-top:1px dashed var(--border); padding-top:10px}
  .kvp h3{margin:0 0 8px; font-size:.95rem; color:#334155; font-weight:700}
  .kvp-cols{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .kvp ul{margin:0; padding-left:18px; color:var(--muted); font-size:.85rem; line-height:1.35}
  .kvp li{margin:4px 0}

  /* Summary */
  .section-label{font-weight:700; color:#334155; margin-bottom:8px}
  .price-row{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
  .old-price{color:#94a3b8; text-decoration:line-through; font-size:1rem}
  .new-price{color:var(--primary); font-weight:800; font-size:clamp(1.35rem,3.8vw,2.1rem)}
  .badge{display:inline-block; background:#dcfce7; color:#065f46; border:1px solid #bbf7d0; padding:6px 10px; border-radius:999px; font-weight:700}
  .breakdown{margin-top:10px; display:grid; gap:6px}
  .row2{display:flex; justify-content:space-between}

  /* Per-SF notes (small, muted) */
  .psf{display:block; font-size:.85rem; color:#94a3b8}
</style>
</head>
<body>
  <div class="shell">
    <div class="box">
      <!-- HEADER -->
      <div class="hero">
        <h1>Instant Quote Calculator</h1>
        <p>Enter the system info to get a free instant comparison.</p>
      </div>

      <!-- CONTENT -->
      <div class="grid">
        <!-- LEFT: Inputs -->
        <div class="pane">
          <header>
            <h2>Your Job Inputs</h2>
            <span class="muted">Five fields</span>
          </header>

          <!-- Mode: Quick vs Itemized -->
          <div class="control">
            <div class="label">Quote Mode</div>
            <div class="seg" role="tablist" aria-label="Quote mode">
              <button id="mode-quick" class="active" role="tab" aria-selected="true">Quick Quote</button>
              <button id="mode-itemized" role="tab" aria-selected="false">Itemized Quote</button>
            </div>
          </div>
          <!-- Build type -->
          <div class="control">
            <div class="label">Build type</div>
            <div class="seg" role="tablist" aria-label="Build type">
              <button id="type-res" class="active" role="tab" aria-selected="true">Residential</button>
              <button id="type-multi" role="tab" aria-selected="false">Multi‑family</button>
            </div>
          </div>

          <!-- Wall area -->
          <div class="control">
            <div class="label">Total wall area (SF)</div>
            <div class="row">
              <input id="sf" type="number" min="0" step="0.00001" value="0" inputmode="numeric" pattern="[0-9.]*"
                     aria-label="Total wall area in square feet" />
            </div>
            <div class="muted">Tip: include openings &amp; waste if that matches your estimating method.</div>
          </div>

          <!-- Carry costs (moved so it appears before Quick/Itemized inputs) -->
          <div class="control">
            <div class="label">Total projected carry costs (USD)</div>
                 <input id="carry-cost" type="number" min="0" step="0.00001" value="0" inputmode="numeric" pattern="[0-9.]*"
                   aria-label="Total project carry costs in USD" />
            <div class="muted">Carry Costs are Discounted Based on time Hydroblok saves you.</div>
          </div>

          <!-- Quick inputs (existing) -->
          <div id="quick-section">
            <div class="control">
              <div class="label">Current materials cost ($/SF)</div>
              <input id="trad-mat-psf" type="number" min="0" step="0.00001" value="0" inputmode="decimal" pattern="[0-9.]*"
                     aria-label="Current materials cost per square foot" />
            </div>
            <div class="control">
              <div class="label">Current labor cost ($/SF)</div>
              <input id="trad-lab-psf" type="number" min="0" step="0.00001" value="0" inputmode="decimal" pattern="[0-9.]*"
                     aria-label="Current labor cost per square foot" />
            </div>
          </div>

          <!-- Itemized inputs (hidden by default) -->
          <div id="itemized-section" style="display:none;">
            <div class="control"><div class="label">Current Itemized Costs (Material $/SF / Labor $/SF)</div></div>
            <div class="control">
              <div class="row">
                <div style="flex:1">
                  <label class="label">WRB</label>
                  <input class="item-mat" data-item="wrb" id="mat-wrb" type="number" min="0" step="0.00001" placeholder="Mat $/SF" />
                </div>
                <div style="flex:1">
                  <label class="label">&nbsp;</label>
                  <input class="item-lab" data-item="wrb" id="lab-wrb" type="number" min="0" step="0.00001" placeholder="Lab $/SF" />
                </div>
              </div>
            </div>
            <div class="control">
              <div class="row">
                <div style="flex:1">
                  <label class="label">EPS Foam</label>
                  <input class="item-mat" data-item="eps" id="mat-eps" type="number" min="0" step="0.00001" placeholder="Mat $/SF" />
                </div>
                <div style="flex:1">
                  <label class="label">&nbsp;</label>
                  <input class="item-lab" data-item="eps" id="lab-eps" type="number" min="0" step="0.00001" placeholder="Lab $/SF" />
                </div>
              </div>
            </div>
            <div class="control">
              <div class="row">
                <div style="flex:1">
                  <label class="label">Metal Wire</label>
                  <input class="item-mat" data-item="wire" id="mat-wire" type="number" min="0" step="0.00001" placeholder="Mat $/SF" />
                </div>
                <div style="flex:1">
                  <label class="label">&nbsp;</label>
                  <input class="item-lab" data-item="wire" id="lab-wire" type="number" min="0" step="0.00001" placeholder="Lab $/SF" />
                </div>
              </div>
            </div>
            <div class="control">
              <div class="row">
                <div style="flex:1">
                  <label class="label">Fasteners</label>
                  <input class="item-mat" data-item="fasteners" id="mat-fasteners" type="number" min="0" step="0.00001" placeholder="Mat $/SF" />
                </div>
                <div style="flex:1">
                  <label class="label">&nbsp;</label>
                  <input class="item-lab" data-item="fasteners" id="lab-fasteners" type="number" min="0" step="0.00001" placeholder="Lab $/SF" />
                </div>
              </div>
            </div>
            <div class="control">
              <div class="row">
                <div style="flex:1">
                  <label class="label">Metal Trim</label>
                  <input class="item-mat" data-item="trim" id="mat-trim" type="number" min="0" step="0.00001" placeholder="Mat $/SF" />
                </div>
                <div style="flex:1">
                  <label class="label">&nbsp;</label>
                  <input class="item-lab" data-item="trim" id="lab-trim" type="number" min="0" step="0.00001" placeholder="Lab $/SF" />
                </div>
              </div>
            </div>
            <div class="control">
              <div class="row">
                <div style="flex:1">
                  <label class="label">Bldg Prep</label>
                  <input class="item-mat" data-item="prep" id="mat-prep" type="number" min="0" step="0.00001" placeholder="Mat $/SF" />
                </div>
                <div style="flex:1">
                  <label class="label">&nbsp;</label>
                  <input class="item-lab" data-item="prep" id="lab-prep" type="number" min="0" step="0.00001" placeholder="Lab $/SF" />
                </div>
              </div>
            </div>
            <div class="control">
              <div class="row">
                <div style="flex:1">
                  <label class="label">Base Coat</label>
                  <input class="item-mat" data-item="base" id="mat-base" type="number" min="0" step="0.00001" placeholder="Mat $/SF" />
                </div>
                <div style="flex:1">
                  <label class="label">&nbsp;</label>
                  <input class="item-lab" data-item="base" id="lab-base" type="number" min="0" step="0.00001" placeholder="Lab $/SF" />
                </div>
              </div>
            </div>
            <div class="control">
              <div class="row">
                <div style="flex:1">
                  <label class="label">Finish Coat</label>
                  <input class="item-mat" data-item="finish" id="mat-finish" type="number" min="0" step="0.00001" placeholder="Mat $/SF" />
                </div>
                <div style="flex:1">
                  <label class="label">&nbsp;</label>
                  <input class="item-lab" data-item="finish" id="lab-finish" type="number" min="0" step="0.00001" placeholder="Lab $/SF" />
                </div>
              </div>
            </div>
            <div class="control">
              <div class="row">
                <div style="flex:1">
                  <label class="label">Mobilization</label>
                  <input class="item-mat" data-item="mobil" id="mat-mobil" type="number" min="0" step="0.00001" placeholder="Mat $/SF" />
                </div>
                <div style="flex:1">
                  <label class="label">&nbsp;</label>
                  <input class="item-lab" data-item="mobil" id="lab-mobil" type="number" min="0" step="0.00001" placeholder="Lab $/SF" />
                </div>
              </div>
            </div>
            <div class="control">
              <div class="row">
                <div style="flex:1">
                  <label class="label">Scaffolding</label>
                  <input class="item-mat" data-item="scaf" id="mat-scaf" type="number" min="0" step="0.00001" placeholder="Mat $/SF" />
                </div>
                <div style="flex:1">
                  <label class="label">&nbsp;</label>
                  <input class="item-lab" data-item="scaf" id="lab-scaf" type="number" min="0" step="0.00001" placeholder="Lab $/SF" />
                </div>
              </div>
            </div>
            <div class="control">
              <div class="row">
                <div style="flex:1">
                  <label class="label">Cleanup</label>
                  <input class="item-mat" data-item="cleanup" id="mat-cleanup" type="number" min="0" step="0.00001" placeholder="Mat $/SF" />
                </div>
                <div style="flex:1">
                  <label class="label">&nbsp;</label>
                  <input class="item-lab" data-item="cleanup" id="lab-cleanup" type="number" min="0" step="0.00001" placeholder="Lab $/SF" />
                </div>
              </div>
            </div>
          </div>

          <!-- Carry costs (moved above quick/itemized sections) -->
          <!-- (removed from here; placed earlier after Wall area) -->

          <!-- Submit moved here: after all inputs, before Key Points -->
          <div class="actions">
            <button class="btn primary" id="submit">Submit</button>
            <button class="btn" id="reset">Reset</button>
          </div>

          <!-- Key Points -->
          <div class="kvp">
            <h3>Key Points</h3>
            <div class="kvp-cols">
              <ul>
                <li>Better resale value over time</li>
                <li>Builders Insurance Savings</li>
                <li>Carry Insurance Savings</li>
                <li>Shorter Curing Times Between Coats</li>
              </ul>
              <ul>
                <li>No Lath Inspections</li>
                <li>De-risk labor inflation costs</li>
                <li>Reduced Trash Haul Away</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- RIGHT: Summary -->
        <div class="pane">
          <header>
            <h2>Estimate Summary</h2>
            <span class="muted">Traditional vs HydroBlok</span>
          </header>

          <div class="section-label">Traditional Methods:</div>
          <div class="price-row">
            <span class="old-price" id="old-total">$0.00</span>
            <span class="psf" id="old-psf">$0.00/SF</span>
          </div>

          <div class="section-label" style="margin-top:12px">HydroBlok:</div>
          <div class="price-row">
            <div class="new-price" id="new-total">$0.00</div>
            <span class="badge" id="pct">0.0% savings</span>
            <span class="psf" id="new-psf">$0.00/SF</span>
          </div>

          <div class="breakdown" style="margin-top:10px">
            <div class="row2"><span>Traditional materials</span><strong id="old-mat">$0.00</strong></div>
            <div class="row2"><span>Traditional labor</span><strong id="old-lab">$0.00</strong></div>
            <div class="row2"><span>HydroBlok materials</span><strong id="new-mat">$0.00</strong></div>
            <div class="row2"><span>HydroBlok labor</span><strong id="new-lab">$0.00</strong></div>
            <div class="row2"><span>Hydroblok Carry cost</span><strong id="carry-sav">$0.00 (18%)</strong></div>
            <!-- per-item HydroBlok breakdown removed; totals remain above -->
            <div class="row2" style="border-top:1px solid var(--border); padding-top:8px">
              <span>Savings vs traditional</span>
              <div style="display:flex;flex-direction:column;align-items:flex-end">
                <strong id="delta">$0.00</strong>
                <span class="psf" id="delta-psf">$0.00/SF</span>
              </div>
            </div>
          </div>

          <!-- Download CSV and Submit Buttons -->
          <div style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="btn primary" id="create-pdf">Export .XSLX quote</button>
            <button class="btn primary" id="submit-right">Calculate & Submit</button>
          </div>
          <div style="margin-top:10px">
            <span class="muted">Quote susceptible to change based on individual project requirements</span>
          </div>
        </div>
      </div><!-- /grid -->
    </div><!-- /box -->
  </div><!-- /shell -->

<script>
/* Per-SF constants for HydroBlok (keep fixed):
   NEW (HydroBlok): Mat/SF = 5.43; Lab/SF = 3.95; Installed/SF = 9.38
*/
const RATES = {
  new: { mat_psf: 5.43, lab_psf: 3.95 }
};
RATES.new.inst_psf = RATES.new.mat_psf + RATES.new.lab_psf; // 9.38

function fmtUSD(x){
  return new Intl.NumberFormat(undefined, { style:'currency', currency:'USD'}).format(x);
}

// Build type segmented control
const typeResBtn   = document.getElementById('type-res');
const typeMultiBtn = document.getElementById('type-multi');
let buildType = 'res'; // 'res' | 'multi'

typeResBtn.addEventListener('click', ()=>{
  buildType = 'res';
  typeResBtn.classList.add('active');  typeResBtn.setAttribute('aria-selected','true');
  typeMultiBtn.classList.remove('active'); typeMultiBtn.setAttribute('aria-selected','false');
});
typeMultiBtn.addEventListener('click', ()=>{
  buildType = 'multi';
  typeMultiBtn.classList.add('active'); typeMultiBtn.setAttribute('aria-selected','true');
  typeResBtn.classList.remove('active'); typeResBtn.setAttribute('aria-selected','false');
});

const sfEl        = document.getElementById('sf');
const carryCostEl = document.getElementById('carry-cost');
const tradMatPsfEl= document.getElementById('trad-mat-psf');
const tradLabPsfEl= document.getElementById('trad-lab-psf');
const submitBtn   = document.getElementById('submit');
// Mode elements
const modeQuickBtn = document.getElementById('mode-quick');
const modeItemBtn  = document.getElementById('mode-itemized');
const quickSection = document.getElementById('quick-section');
const itemizedSection = document.getElementById('itemized-section');
let quoteMode = 'quick'; // 'quick' | 'itemized'

// Mode toggle handlers
modeQuickBtn.addEventListener('click', () => {
  quoteMode = 'quick';
  modeQuickBtn.classList.add('active'); modeQuickBtn.setAttribute('aria-selected','true');
  modeItemBtn.classList.remove('active'); modeItemBtn.setAttribute('aria-selected','false');
  quickSection.style.display = '';
  itemizedSection.style.display = 'none';
});
modeItemBtn.addEventListener('click', () => {
  quoteMode = 'itemized';
  modeItemBtn.classList.add('active'); modeItemBtn.setAttribute('aria-selected','true');
  modeQuickBtn.classList.remove('active'); modeQuickBtn.setAttribute('aria-selected','false');
  quickSection.style.display = 'none';
  itemizedSection.style.display = '';
});

function renderTotals(){
  // Read inputs and respect true zero
  let sf = Number(sfEl.value || 0);
  if (isNaN(sf) || sf < 0) sf = 0;
  
  let carryCost = Number(carryCostEl.value || 0);
  if (isNaN(carryCost) || carryCost < 0) carryCost = 0;
  
  const carryPct   = buildType === 'res' ? 0.18 : 0.15; // Residential 18%, Multi-family 15%
  const carrySav   = carryCost * carryPct;

  // Temporary debug logging
  console.log('DEBUG renderTotals:', { sf, carryCost, carryPct, buildType, quoteMode });

  // Traditional user-entered $/SF — source depends on mode
  let tradMatPsf = 0, tradLabPsf = 0;
  if (quoteMode === 'quick'){
    tradMatPsf = Number(tradMatPsfEl.value || 0);
    if (isNaN(tradMatPsf) || tradMatPsf < 0) tradMatPsf = 0;
    
    tradLabPsf = Number(tradLabPsfEl.value || 0);
    if (isNaN(tradLabPsf) || tradLabPsf < 0) tradLabPsf = 0;
  } else {
    // Sum itemized fields (each input is $/SF)
    const matEls = document.querySelectorAll('.item-mat');
    const labEls = document.querySelectorAll('.item-lab');
    tradMatPsf = Array.from(matEls).reduce((s, e) => {
      let val = Number(e.value || 0);
      return s + (isNaN(val) || val < 0 ? 0 : val);
    }, 0);
    tradLabPsf = Array.from(labEls).reduce((s, e) => {
      let val = Number(e.value || 0);
      return s + (isNaN(val) || val < 0 ? 0 : val);
    }, 0);
  }
  const tradInstPsf= tradMatPsf + tradLabPsf;

  console.log('DEBUG traditional $/SF:', { tradMatPsf, tradLabPsf, tradInstPsf });

  // Traditional totals (material + labor)
  const oldMat = tradMatPsf * sf;
  const oldLab = tradLabPsf * sf;
  const oldTotBase = tradInstPsf * sf;
  
  // Add full carry cost to traditional total
  const oldTot = oldTotBase + carryCost;

  // HydroBlok totals (material + labor)
  const newMat = RATES.new.mat_psf * sf;
  const newLab = RATES.new.lab_psf * sf;
  const newTotBase = RATES.new.inst_psf * sf;

  console.log('DEBUG totals before carry:', { oldTotBase, newTotBase, carryCost, carryPct });

  // Per-item breakdown removed — display only aggregate HydroBlok totals

  // Add discounted carry cost to HydroBlok (cost minus the savings percentage)
  const carryDiscountedForHydro = carryCost * (1 - carryPct);
  const newTot = newTotBase + carryDiscountedForHydro;

  // Comparison
  const delta = Math.max(0, oldTot - newTot);
  const pct   = oldTot > 0 ? ((oldTot - newTot) / oldTot) * 100 : 0; // % savings vs traditional

  console.log('DEBUG final totals:', { oldTot, newTot, carryDiscountedForHydro, delta, pct });

  // Per-SF notes
  const oldPerSF   = (sf > 0) ? (oldTot / sf) : 0;
  const newPerSF   = (sf > 0) ? (newTot / sf) : 0;           // effective per-SF with carry cost applied
  const deltaPerSF = (sf > 0) ? ((oldTot - newTot) / sf) : 0;

  console.log('DEBUG per-SF:', { oldPerSF, newPerSF, deltaPerSF });

  // Render totals
  document.getElementById('old-total').textContent = fmtUSD(oldTot);
  document.getElementById('new-total').textContent = fmtUSD(newTot);
  document.getElementById('old-mat').textContent   = fmtUSD(oldMat);
  document.getElementById('old-lab').textContent   = fmtUSD(oldLab);
  document.getElementById('new-mat').textContent   = fmtUSD(newMat);
  document.getElementById('new-lab').textContent   = fmtUSD(newLab);
  document.getElementById('carry-sav').textContent = `${fmtUSD(carryDiscountedForHydro)} (discounted ${(carryPct*100).toFixed(0)}%)`;
  document.getElementById('delta').textContent     = fmtUSD(delta);
  document.getElementById('pct').textContent       = `${pct.toFixed(1)}% savings`;

  // Render per-SF notes
  document.getElementById('old-psf').textContent   = `${fmtUSD(oldPerSF)}/SF`;
  document.getElementById('new-psf').textContent   = `${fmtUSD(newPerSF)}/SF`;
  document.getElementById('delta-psf').textContent = `${fmtUSD(deltaPerSF)}/SF`;
}

// Submit button triggers calculation
submitBtn.addEventListener('click', () => {
  renderTotals();
});

// Submit button on right (same function)
document.getElementById('submit-right').addEventListener('click', () => {
  renderTotals();
});

// Reset
document.getElementById('reset').addEventListener('click', ()=>{
  buildType = 'res';
  typeResBtn.classList.add('active');  typeResBtn.setAttribute('aria-selected','true');
  typeMultiBtn.classList.remove('active'); typeMultiBtn.setAttribute('aria-selected','false');

  sfEl.value = 0;
  carryCostEl.value = 0;
  tradMatPsfEl.value = 0;
  tradLabPsfEl.value = 0;
  // clear itemized inputs as well (clear so placeholders show)
  document.querySelectorAll('.item-mat, .item-lab').forEach(i => i.value = '');
  renderTotals();
});

// Generate Excel Quote
document.getElementById('create-pdf').addEventListener('click', function(){
  try {
    const sf = Math.max(0, Number(sfEl.value || 0));
    const carryCost = Math.max(0, Number(carryCostEl.value || 0));
    const carryPct = buildType === 'res' ? 0.18 : 0.15;
    
    let tradMatPsf = 0, tradLabPsf = 0;
    if (quoteMode === 'quick'){
      tradMatPsf = Math.max(0, Number(tradMatPsfEl.value || 0));
      tradLabPsf = Math.max(0, Number(tradLabPsfEl.value || 0));
    } else {
      const matEls = document.querySelectorAll('.item-mat');
      const labEls = document.querySelectorAll('.item-lab');
      tradMatPsf = Array.from(matEls).reduce((s, e) => { let val = Number(e.value || 0); return s + (isNaN(val) || val < 0 ? 0 : val); }, 0);
      tradLabPsf = Array.from(labEls).reduce((s, e) => { let val = Number(e.value || 0); return s + (isNaN(val) || val < 0 ? 0 : val); }, 0);
    }
    
    const oldMat = tradMatPsf * sf;
    const oldLab = tradLabPsf * sf;
    const oldTotBase = (tradMatPsf + tradLabPsf) * sf;
    const oldTot = oldTotBase + carryCost;
    
    const newMat = RATES.new.mat_psf * sf;
    const newLab = RATES.new.lab_psf * sf;
    const newTotBase = RATES.new.inst_psf * sf;
    const carryDiscountedForHydro = carryCost * (1 - carryPct);
    const newTot = newTotBase + carryDiscountedForHydro;
    
    const delta = Math.max(0, oldTot - newTot);
    const pct = oldTot > 0 ? ((oldTot - newTot) / oldTot) * 100 : 0;
    
    const perSFTrad = oldTot / (sf > 0 ? sf : 1);
    const perSFHydro = newTot / (sf > 0 ? sf : 1);
    
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    const quoteNum = 'QB-' + now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0');
    
    // Collect itemized data if in itemized mode — include all itemized inputs (show all 11 rows)
    let itemizedRows = [['ITEMIZED MATERIALS & LABOR'], ['Item', 'Mat $/SF', 'Lab $/SF']];
    if (quoteMode === 'itemized') {
      const matEls = document.querySelectorAll('.item-mat');
      const labEls = document.querySelectorAll('.item-lab');
      for (let i = 0; i < matEls.length; i++) {
        const matInput = matEls[i];
        const labInput = labEls[i];
        // find the label text near the input (same container)
        let name = '';
        try {
          const lbl = matInput.parentElement.querySelector('.label');
          name = lbl ? String(lbl.textContent || '').trim() : ('Item ' + (i+1));
        } catch (e) {
          name = 'Item ' + (i+1);
        }
        const mat = Number(matInput.value || 0);
        const lab = Number((labInput && labInput.value) || 0);
        // push every row (do not filter) so the exported sheet always contains all items
        itemizedRows.push([name, mat, lab]);
      }
    }
    
    // Prevent exporting if both totals are zero
    if ((oldTot === 0 || oldTot === 0.0) && (newTot === 0 || newTot === 0.0)) {
      alert('Cannot export: quote totals are zero. Enter inputs and calculate before exporting.');
      return;
    }

    // Create workbook data
    const ws_data = [];
    const boldRows = [];
    
    ws_data.push(['HydroBlok Quote - ' + sf + ' SF']);
    boldRows.push(0);
    // Disclaimer in sheet at D1
    ws_data[0] = ws_data[0] || [];
    ws_data[0][3] = 'Quote susceptible to change based on individual project requirements';
    
    ws_data.push([]);
    ws_data.push(['QUOTE INFORMATION']);
    boldRows.push(2);
    ws_data.push(['Quote Number', quoteNum]);
    ws_data.push(['Date', dateStr]);
    ws_data.push(['Build Type', buildType === 'res' ? 'Residential' : 'Multi-family']);
    ws_data.push(['Quote Mode', quoteMode === 'quick' ? 'Quick Quote' : 'Itemized Quote']);
    
    ws_data.push([]);
    ws_data.push(['JOB DETAILS']);
    boldRows.push(8);
    ws_data.push(['Total Wall Area (SF)', sf]);
    ws_data.push(['Projected Carry Costs', carryCost]);
    ws_data.push(['Carry Cost Discount Rate', (carryPct*100).toFixed(0) + '%']);
    
    ws_data.push([]);
    ws_data.push(['TRADITIONAL METHOD PRICING']);
    boldRows.push(13);
    ws_data.push(['Materials per SF', tradMatPsf]);
    ws_data.push(['Labor per SF', tradLabPsf]);
    ws_data.push(['Total Cost per SF', tradMatPsf + tradLabPsf]);
    ws_data.push(['Materials Total (' + sf + ' SF)', oldMat]);
    ws_data.push(['Labor Total (' + sf + ' SF)', oldLab]);
    ws_data.push(['Installation Base Cost', oldTotBase]);
    ws_data.push(['Carry Costs', carryCost]);
    ws_data.push(['TRADITIONAL TOTAL', oldTot]);
    boldRows.push(20);
    ws_data.push(['Traditional Cost per SF', perSFTrad]);
    
    ws_data.push([]);
    ws_data.push(['HYDROBLOK PRICING']);
    boldRows.push(23);
    ws_data.push(['Materials per SF', RATES.new.mat_psf]);
    ws_data.push(['Labor per SF', RATES.new.lab_psf]);
    ws_data.push(['Total Cost per SF', RATES.new.inst_psf]);
    ws_data.push(['Materials Total (' + sf + ' SF)', newMat]);
    ws_data.push(['Labor Total (' + sf + ' SF)', newLab]);
    ws_data.push(['Installation Base Cost', newTotBase]);
    ws_data.push(['Carry Costs (Discounted ' + (carryPct*100).toFixed(0) + '%)', carryDiscountedForHydro]);
    ws_data.push(['HYDROBLOK TOTAL', newTot]);
    boldRows.push(31);
    ws_data.push(['HydroBlok Cost per SF', perSFHydro]);
    
    ws_data.push([]);
    ws_data.push(['COST COMPARISON']);
    boldRows.push(34);
    ws_data.push(['Traditional Total Cost', oldTot]);
    ws_data.push(['HydroBlok Total Cost', newTot]);
    ws_data.push(['TOTAL SAVINGS', delta]);
    boldRows.push(37);
    ws_data.push(['Savings Percentage', pct.toFixed(1) + '%']);
    
    ws_data.push([]);
    ws_data.push(['ADVANTAGES']);
    boldRows.push(40);
    ws_data.push(['Better resale value over time']);
    ws_data.push(['Builders insurance savings']);
    ws_data.push(['No lath inspections required']);
    ws_data.push(['De-risk labor inflation costs']);
    ws_data.push(['Shorter curing times between coats']);
    ws_data.push(['Reduced trash haul away and project costs']);
    ws_data.push(['Improved durability and weather resistance']);
    
    // Add itemized data to the right if in itemized mode
    if (quoteMode === 'itemized' && itemizedRows.length > 1) {
      // locate a target header row for the right-side table (search by first column or create one)
      let rightHeaderIdx = ws_data.findIndex(r => r && r[3] && String(r[3]).toString().startsWith('Itemized'));
      if (rightHeaderIdx === -1) {
        // place right table after QUOTE INFORMATION block if present, otherwise after a sensible index
        const quoteInfoIdx = ws_data.findIndex(r => r && r[0] && String(r[0]).startsWith('QUOTE INFORMATION'));
        rightHeaderIdx = (quoteInfoIdx === -1) ? 8 : quoteInfoIdx + 2;
        ws_data[rightHeaderIdx] = ws_data[rightHeaderIdx] || [];
        ws_data[rightHeaderIdx][3] = 'Itemized';
        ws_data[rightHeaderIdx + 1] = ws_data[rightHeaderIdx + 1] || [];
        ws_data[rightHeaderIdx + 1][3] = 'Line Item';
        ws_data[rightHeaderIdx + 1][4] = 'Mat $/SF';
        ws_data[rightHeaderIdx + 1][5] = 'Lab $/SF';
        // mark header rows for bolding
        boldRows.push(rightHeaderIdx, rightHeaderIdx + 1);
      }

      // write item rows starting two rows after our header
      let writeIdx = rightHeaderIdx + 2;
      for (let i = 2; i < itemizedRows.length; i++) {
        const row = itemizedRows[i];
        ws_data[writeIdx] = ws_data[writeIdx] || [];
        ws_data[writeIdx][3] = row[0];
        ws_data[writeIdx][4] = row[1];
        ws_data[writeIdx][5] = row[2];
        writeIdx++;
      }
    }
    
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    ws['!cols'] = [{ wch: 45 }, { wch: 25 }, { wch: 3 }, { wch: 30 }, { wch: 15 }, { wch: 15 }];

    // Format monetary cells with currency number format (up to 5 decimal places, no trailing zeros)
    const moneyFormat = '$#,##0.#####';
    const moneyKeywords = ['cost', 'total', 'materials', 'labor', 'carry', 'savings', 'mat $/sf', 'lab $/sf', 'per sf'];
    for (let r = 0; r < ws_data.length; r++) {
      const row = ws_data[r] || [];
      const label = (row[0] || '').toString().toLowerCase();
      // Column 1: many values live here (format when the label implies money)
      if (typeof row[1] === 'number') {
        if (moneyKeywords.some(k => label.indexOf(k) !== -1) || /total|cost|carry|materials|labor|savings/i.test(label)) {
          const cellRef = XLSX.utils.encode_col(1) + (r + 1);
          if (!ws[cellRef]) ws[cellRef] = {};
          ws[cellRef].t = 'n';
          ws[cellRef].v = Number(row[1]);
          ws[cellRef].z = moneyFormat;
        }
      }
      // Right-hand itemized columns (4 and 5) — always format numeric entries as money
      [4,5].forEach(col => {
        if (typeof row[col] === 'number') {
          const cellRef = XLSX.utils.encode_col(col) + (r + 1);
          if (!ws[cellRef]) ws[cellRef] = {};
          ws[cellRef].t = 'n';
          ws[cellRef].v = Number(row[col]);
          ws[cellRef].z = moneyFormat;
        }
      });
    }

    // Apply bold formatting to headers and totals
    boldRows.forEach(rowIdx => {
      [0, 1, 3, 4, 5].forEach(colIdx => {
        if (ws_data[rowIdx] && ws_data[rowIdx][colIdx] !== undefined && ws_data[rowIdx][colIdx] !== null) {
          const cellRef = XLSX.utils.encode_col(colIdx) + (rowIdx + 1);
          if (!ws[cellRef]) ws[cellRef] = {};
          if (!ws[cellRef].s) ws[cellRef].s = {};
          ws[cellRef].s.font = Object.assign({}, ws[cellRef].s.font, { bold: true });
        }
      });
    });
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Quote');
    const sfStr = Number.isInteger(sf) ? String(sf) : String(sf).replace('.', '_');
    const filename = 'HydroBlok-Quote-' + sfStr + 'SF-' + quoteNum + '.xlsx';
    XLSX.writeFile(wb, filename);
    
  } catch(e) {
    console.error('Export error:', e);
    alert('Error generating export: ' + e.message);
  }
});

// Initialize with true zero
renderTotals();
</script>
</body>
</html>

